# H6

### Kurssin tehtävät:
* [Repository:n pääsivu](https://github.com/mikorpi/Pentest-2020-Autumn)
* [Harjoitus 1/WebGoat](https://github.com/mikorpi/Pentest-2020-Autumn/blob/main/H1.md)
* [Harjoitus 2/OWASP10/WebGoat/MITRE](https://github.com/mikorpi/Pentest-2020-Autumn/blob/main/H2.md)
* [Harjoitus 3/Aktiivinen tiedustelu](https://github.com/mikorpi/Pentest-2020-Autumn/blob/main/H3.md)
* [Harjoitus 4/HTB-läpikäyntejä & työkaluja](https://github.com/mikorpi/Pentest-2020-Autumn/blob/main/H4.md)
* [Harjoitus 5/Metasploit-framework & Metasploitable2](https://github.com/mikorpi/Pentest-2020-Autumn/blob/main/H5/H5.md)

![hcat](https://github.com/mikorpi/Pentest-2020-Autumn/blob/main/H6/images/hashcat.png)

## [Hashcat](https://hashcat.net/hashcat/)
* Hashcat on salasanojen/tiivisteiden murtotyökalu.
* "Edistynyttä salasanan palautusta"

Tässä tehtävässä murretaan tiivisteitä. Syystä tai toisesta Hashcat ei halunnut toimia virtuaalikoneellani joten latasin sen varsinaiselle koneelleni (Windows10). Joku nero joskus tokaisi että ei ole syytä käyttää hashcattia virtuaalikoneessa sillä siitä on versio "jokaiselle" käyttöjärjestelmälle. Näytönohjaimena toimii `GeForce GTX 1060 6GB`.

### MD5-tiivisteen murtaminen sanalistalla:

Jotta tämä ei ole liian helponnäköistä, loin MD5-tiivisteen Kali-virtuaalikoneessani.

`$ echo -n "moikkakaikille!!!" | md5sum | tr -d " -" >> hash.txt`

Murretaan edelliskohdassa tehty MD5-tiiviste omalla kustomoidulla sanalistalla Windows:issa. `-m`-parametri kertoo mitä modea käytetään, 0 on MD5:selle:

`C:\>hashcat.exe -m 0 hash.txt sanalista.txt `

![hashcatmd5](https://github.com/mikorpi/Pentest-2020-Autumn/blob/main/H6/images/md5_moikkakaikille.png)

Kustomoitu sanalistani oli pieni, hashcat ei päässyt täyteen vauhtiin ja ehdotti oikeaa vastausta kandidaattina.

### MD5-tiivisteen murtaminen Mask-hyökkäyksellä:

Mask-hyökkäys on kuin bruteforce-hyökkäys mutta spesifimpi. Pääset valitsemaan "maskeja" jotta hashcat:in ei tarvitse paukuttaa bruteforcella jokaista merkkiä. Tätä hyökkäystyyppiä on hyvä käyttää jos tiedossasi on murron kohteena olevan salasanan piirteitä (lue: salasanapolitiikka), esim. että se loppuu kahdella numerolla, alkaa isolla alkukirjaimella ja niin edespäin. Maskihyökkäys on täsmällinen salasanan pituutta kohtaan. [Lisää tietoa täältä.](https://hashcat.net/wiki/doku.php?id=mask_attack)

Luodaan MD5-tiiviste sanasta:

`$ echo -n "salainen" | md5sum | tr -d " -" >> hash.txt`

Esimerkki: Olemme saaneet selville että kohteen salasanat on hashattu MD5:sella ja ne ovat 8 merkkiä pitkiä ja sisältävät vain pieniä kirjaimia. Täten maskimme tulee kattaa 8 merkkiä, ja asetamme sen kokeilemaan aakkosia(ASCII) pienellä(lowercase).

Hashcat:in sisäänrakennetut merkkisarjat:
```
?l = abcdefghijklmnopqrstuvwxyz
?u = ABCDEFGHIJKLMNOPQRSTUVWXYZ
?d = 0123456789
?h = 0123456789abcdef
?H = 0123456789ABCDEF
?s = «space»!"#$%&'()*+,-./:;<=>?@[\]^_`{|}~
?a = ?l?u?d?s
?b = 0x00 – 0xff
```
Olemme myös hyvin laiskoja kirjoittamaan joten:
```python3
$ python3                  
Python 3.8.6 (default, Sep 25 2020, 09:36:53)                                                                                 
[GCC 10.2.0] on linux                                                                                             
Type "help", "copyright", "credits" or "license" for more information.                                                               
>>> "?l" * 8                                                   
'?l?l?l?l?l?l?l?l'
>>>                                        
```

laitetaan hashcat tulille Windows10-koneella. Huomaa että `attackmode` on 3 eli bruteforce.

`C:\>hashcat.exe -m 0 -a 3 hash.txt ?l?l?l?l?l?l?l?l`

![hashcat_maskattack](https://github.com/mikorpi/Pentest-2020-Autumn/blob/main/H6/images/md5_maskattack.png)

Success. Hashcat mursi tiivisteen yhdeksässä sekunnissa. `2980b5745aa680af4465eae059992bd3:salainen`


### SHA512 murtoa sanalistalla

* Luodaan testikäyttäjä : `$ sudo adduser crackme`
* `$ cat /etc/shadow | grep "crackme" >> hash.txt` siirretään crackme-käyttäjän tiiviste hash.txt:iin, poistetaan käyttäjätunnusosa ja loppuosa.
* `$6$uS8nG8u3v5J1Zo0x$qaKw3ZJP1abKrFemi7O2WkzjYuEEpKGBB7s57hDaTodlRoGTEYrhXAafTxRP1uyKKtLUzFFMHrgfv4xKPNhv7`
* Tiiviste avattuna: `Käyttäjätunnus$salasanatyyppi$SALT$SALASANA...` eli crackme,SHA-512,suola = `uS8nG8u3v5J1Zo0x`,salasana.


Sanalistana https://weakpass.com/wordlist/1850


### SHA1-tiivisteen murtoa (sha1($pass.$salt)) maskihyökkäyksellä

* Luodaan sha1sum : `$ echo -n "111233340000000000000000" | sha1sum | tr -d " -" >> hash.txt`
  * `hash.txt`:iin pitää vielä lisätä `:0000000000000000` päätteeksi, joka toimii suolana.

Ajetaan hashcat(win10) komennolla `C:\>hashcat.exe -m 110 -a 3 hash.txt ?d?d?d?d?d?d?d?d`
* Luotiin siis 8 merkin pituinen SHA1 joten maskikin on sen mukainen. Maski selitettynä MD5-kohdassa ( hieman ylempänä)

![sha1passsalt](https://github.com/mikorpi/Pentest-2020-Autumn/blob/main/H6/images/sha1_eka.png)


### Python passlib pbkdf2-sha256	- murtoa maskihyökkäyksellä
* Luodaan pbkdf2-sha256-pohjainen salasanatiiviste:

```python
$ python3
Python 3.8.6 (default, Sep 25 2020, 09:36:53) 
[GCC 10.2.0] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> from passlib.hash import pbkdf2_sha256
>>> h = pbkdf2_sha256.hash("eu1")
>>> h
'$pbkdf2-sha256$29000$hzAGgBACIMSYs9b6n9OaEw$zBIaWcnNUiyVh8dWNQ0NZ14REksdSnQRlVE.mpkHQUU'
>>> pbkdf2_sha256.verify("eu1",h)
True
>>> quit()
```
* Kopioidaan luotu tiiviste `hash.txt`:iin tai syötetään suoraan komentokehotteeseen
* Meillä on tiedossa että kohteen salasanapolitiikka on hyvin pielessä, he käyttävät kolmen merkin pituisia salasanoja
* `?a` -merkkisarja kokeilee aakkoset(ASCII) isolla sekä pienellä, numerot ja merkit ```«space»!"#$%&'()*+,-./:;<=>?@[\]^_`{|}~```
* Ajetaan hashcat.exe komennolla `C:\>hashcat -m 20300 -a 3 hash.txt ?a?a?a`
* Tiiviste kräkätty!
```
$pbkdf2-sha256$29000$hzAGgBACIMSYs9b6n9OaEw$zBIaWcnNUiyVh8dWNQ0NZ14REksdSnQRlVE.mpkHQUU:eu1

Session..........: hashcat
Status...........: Cracked
Hash.Name........: Python passlib pbkdf2-sha256
Hash.Target......: $pbkdf2-sha256$29000$hzAGgBACIMSYs9b6n9OaEw$zBIaWcn...pkHQUU
Time.Started.....: Sun Dec 13 00:22:21 2020 (12 secs)
Time.Estimated...: Sun Dec 13 00:22:33 2020 (0 secs)
Guess.Mask.......: ?a?a?a [3]
Guess.Queue......: 1/1 (100.00%)
Speed.#1.........:    15381 H/s (2.34ms) @ Accel:4 Loops:128 Thr:1024 Vec:1
Recovered........: 1/1 (100.00%) Digests
Progress.........: 189525/857375 (22.11%)
Rejected.........: 0/189525 (0.00%)
Restore.Point....: 0/9025 (0.00%)
Restore.Sub.#1...: Salt:0 Amplifier:20-21 Iteration:28928-28999
Candidates.#1....: ear -> e ~
Hardware.Mon.#1..: Temp: 64c Fan: 33% Util: 95% Core:1898MHz Mem:4006MHz Bus:16

Started: Sun Dec 13 00:22:18 2020
Stopped: Sun Dec 13 00:22:34 2020
```

### phpass (WordPress & Drupal) - murtoa maskihyökkäyksellä
Tässä esimerkissä käytin [hashcat:in](https://hashcat.net/wiki/doku.php?id=example_hashes) esimerkkiä minkä mursin asteittaisella (incremental) maskihyökkäyksellä käyttäen kustomoitua maskia(`.hcmask`). Siirsin esimerkkitiivisteen `hash.txt`:iin.

Loin oman maskin `\mask`-hakemistoon, joka kokeilee ensin viiden kirjaimen(lalpha) salasanoja, siirtyen kuuteen -> seitsemään -> kahdeksaan. `mymask.hcmask`:in sisältö alapuolella:
```hcmask
?l?l?l?l?l
?l?l?l?l?l?l
?l?l?l?l?l?l?l
?l?l?l?l?l?l?l?l
```
Ajetaan hashcat kustomoidulla maskilla toteuttaen asteittainen maskihyökkäys. Ota huomioon että käyttikseni on W10, joten hakemistot ovat `\` takana eikä `/`.

`C:\>hashcat.exe -m 400 -a 3 hash.txt \masks\mymask.hcmask `

![asdsd](https://github.com/mikorpi/Pentest-2020-Autumn/blob/main/H6/images/phpass_incrementalmask.png)

### 7z-tiivisteen murtoa hashcatilla käyttäen sanalistaa (7z2John + Hashcat)

![jtr](https://github.com/mikorpi/Pentest-2020-Autumn/blob/main/H6/images/jtr.jpg)

* Zipataan kohteemme 7z:lla : `$ 7za a kohde.7z -p kohde`
* Käytetään `7z2john`:ia jotta saadaan tiiviste.
* `7z2john.pl` oli dependansseja mitkä eivät toteutunut itselläni, nopea fiksi jos se herjaa niistä on : `sudo apt install libcompress-raw-lzma-perl -y`
* Ajetaan `7z2john.pl` .7z-tiedostoamme vastaan.
* `$ /usr/share/john/7z2john.pl kohde.7z`
* `kohde.7z:$7z$2$19$0$$8$2fcc23dc6b866b320000000000000000$2053347695$48$36$22ba0f5cfac209a16893b18b4feea64b021a73b45e43f2e0319dfdc942f6c9713c53f43bdc5a06da15dabc2e8dda17c4$32$00`

Siiretään tiiviste, joka alkaa `$7z$`-tunnuksella `hash.txt`:iin. Luodaan oma sanalista, käytetään arvauksia ja appendataan sanalistaa [SecList:in darkc0de.txt:lla](https://github.com/danielmiessler/SecLists/blob/master/Passwords/darkc0de.txt). `rockyou.txt` olisi myös varteenotettava vaihtoehto.

Ajetaan Win10 hashcat.exe:lla : `C:\>hashcat.exe -m 11600 -a 0 hash.txt sanalista.txt`

![win](https://github.com/mikorpi/Pentest-2020-Autumn/blob/main/H6/images/hashcat_7zip.png)

Success, kräkätty salasana on `delete`.

## Lähteet
* [Hashcat_example_hashes](https://hashcat.net/wiki/doku.php?id=example_hashes)

* [Maskihyökkäys](https://hashcat.net/wiki/doku.php?id=mask_attack)

* [Python passlib pbkdf2-sha256](https://passlib.readthedocs.io/en/stable/lib/passlib.hash.pbkdf2_digest.html#passlib.hash.pbkdf2_sha256)

* [phpass](https://passlib.readthedocs.io/en/stable/lib/passlib.hash.phpass.html#passlib.hash.phpass)

* [darkc0de.txt](https://github.com/danielmiessler/SecLists/blob/master/Passwords/darkc0de.txt)

* [Debian_Package: libcompress-raw-lzma-perl (2.066-1)/7Z2JOHN.pl_DEPENDANCY_FIX](https://packages.debian.org/jessie/libcompress-raw-lzma-perl)
