# Harjoitus 3 | Aktiivinen tiedustelu/Active recon

#### z) Lue artikkelit ja katso videot, tee kustakin muistiinpanot (muutama ranskalainen viiva per artikkeli/video).

[Surveying Essential Tools for Active Reconnaissance](https://learning.oreilly.com/videos/the-art-of/9780135767849/9780135767849-SPTT_04_01)

* On olemassa passiivista ja aktiivista tiedustelua. Passiivisessa tiedustelussa ei lähetetä mitään paketteja suoraan kohdeympäristöön.
* Aktiivisessa tiedustelussa, kuten maalikoneen porttienskannauksessa voi jäädä jälkiä lokiin.
* Nmapista on moneksi, porttiskannaus on vain yksi ominaisuus.
* Verkkohaavoittuvuusskannerit(nmap, OpenVAS) & Webbihaavoittuvuusskannerit(Nikto, Burp Suite,SQLMap)


[Nmap yleiskatsaus ja Case](https://nmap.org/book/nmap-overview-and-demos.html

* Nmapin yleiskatsausta ja fiktiivinen case.
* Haavoittuvuusarviointi alkaa määrittelemällä mitä IP-osoitealueita maalikohde käyttää, mitkä hostit ovat ylhäällä, mitä palveluita nämä hostit tarjoavat, yleinen verkkotopologia ja mitä palomuuri/filtteröintipolitiikkoja on päällä. 
* Enumeroi jokaisen IP-osoitteen kohteen verkkolohkossa (``-sL``) ja suorittaa käänteisen DNS-lookupin. Viekas tapa, sillä tämä ei hälytä vielä mitään kelloja todennäköisesti.
* Saa selville karkeasti kuinka monta konetta on käytössä ja suuntaa mihin niitä käytetään.
* Seuraavaksi voidaan edetä enemmän tunkeutuvaan skannaukseen mihin kuuluu mm. OS- ja palveluidenversio detektiota.

[Nmap manuaali](https://nmap.org/book/man.html)

* Nmap manuaali
* Pitkä. Todella pitkä.
* Tiivistelmä miten nmappia ajetaan. ``nmap [ <Scan Type> ...] [ <Options> ] { <target specification> }``

[Nmap porttiskannauksen perusteet](https://nmap.org/book/man-port-scanning-basics.html)

* Nmap jakaa portit kuuteen tilaan
* Open = Applikaatio hyväksyy TCP/UDP tai SCTP - yhteyksiä.
* Closed = Suljettu, hyväksyy paketteja mutta ei applikaatioita kuuntelemassa porttia.
* Filtered = Nmap ei osaa sanoa onko portti auki vai kiinni koska pakettifiltteröinti estää sen luotaimia saavuttamasta porttia. Yleensä tarkoittaa että palomuuri filtteröi. Ei anna informaatioita skannaajalle.
* Unfiltered = Portti on saatavilla mutta Nmap ei pysty määrittämään onko se kiinni vai auki. SYN tai FIN skannaus saattaa paljastaa enemmän ( Onko portti auki vai kiinni.)
* Open|filtered = Tähän tilaan päädytään kun Nmap ei kykene määrittelemään onko portti auki vai filtteröity. Tapahtuu kun aukinainen portti ei vastaa.
* Closed|filtered = Nmap ei kykene määrittelemään onko portti kiinni vai filtteröity.
* Tietoturvan perusteet kurssin käyneet yksilöt ovat todennäköisesti tutustuneet näihin tiloihin. Meillä oli ainakin tentissä kysymys juurikin näistä.

[Nmap porttiskannaustekniikoita](https://nmap.org/book/man-port-scanning-techniques.html)

* Lista parametreistä mitä nmap hyväksyy ja mitä ne tekevät
* ``-sS`` parametri tarkoittaa TCP SYN-skannausta, suosituin metodi. Nopea ja melko huomaamaton sillä se ei vie TCP-yhteyksiä loppuun saakka. Antaa luotettavaa dataa portin tilasta.
* ``-sT`` parametri on TCP-yhteysskannaus. Hyvä vaihtoehto kun SYN-skannausta ei voi suorittaa. Tätä yhteyttä käyttää mm. peer2peer-clientit ja webbiselaimet.
* ``-sU`` parametri on UDP-skannausta. Hitaampaa ja "vaikeampaa" kuin TCP-skannaus. Hyvät hyökkääjät eivät koskaan jätä välistä protokollia missä voi piillä haavoittuvuuksia. Versiodetektiota ``-sV``-parametrillä voidaan käyttää avustajana UDP-skannauksessa jotta saadaan selville portit jotka hyväksyvät liikenettä.
* Voit yhdistellä TCP-skannausmetodeita UDP:n kanssa.

#### a) Miten nmap toimii?

Viritetään wireshark kuuntelemaan VPN-liitäntää eli tun0 (HackTheBox-VPN). Juoksutetaan komento ``sudo nmap -sT 10.10.10.198 -v`` (Kohde IP-osoite on Buff-maalikoneen IP.)
* Nmap epäilee että host on alhaalla. TCP-yhteysskannaus suoritettu.
* Wireshark-pakettikaappaus : 
```
14 63.215684154   10.10.15.9 → 10.10.10.198 TCP 60 45624 → 80 [SYN] Seq=0 Win=64240 Len=0 MSS=1460 SACK_PERM=1 TSval=2859221879 TSecr=0 WS=128
 ```
Analysointia : Oma_IP -> MAALIKONE_IP. TCP:tä käyttäen porttiin 80. Kyseessä SYN-paketti mitä käytetään TCP-handshake istunnon setuppaamiseen. Seuraavat kohdat ovat paketin valinnaisia TCP-parametrejä.
``SACK_PERM=1`` tarkoittaa että noodi ``OMA_IP`` osaa hyödyntää SACK-mekanismia (Selective Acknowledgment). Auttaa pakettien häviämisen korjaamisessa. Pähkinänkuoressa : Vastaanottava kone lähettää takaisin SACK-paketteja lähettäjälle että data on saapunut ja lähettäjä voi lähettää uudelleen puuttuvat datasegmentit.
Tsval/TSecr on TCP-aikaleima. ``WS=128`` tarkoittaa sitä että se käyttää Window Scalingia.

Seuraava kohta. "Stealthscanning". ``$ sudo nmap -sS -v 10.10.10.198``. Tämä skannausmetodi ei vie TCP-yhteyksiä loppuun. Saatiin huomattavasti enemmän dataa wiresharkkiin. Pelkkä oletusporttien skannaus tuotti 2027 -paketin liikenteen.

![wshark](https://github.com/mikorpi/Pentest-2020-Autumn/blob/main/images/wireshark_ss.png)

Analysointia : Ensinmäiseksi lähtee ICMP-pingipyyntö. Sitten alkaa TCP-yhteyden muodostaminen, mutta ei kokonaan. Lähettäjältä SYN-paketti kohteelle ja sitten odotellaan vastausta. Jos vastaus SYN/ACK, se indikoi että porttia kuuntelee jokin applikaatio(tila=open). RST eli reset indikoi ei-kuuntelevaa porttia. Ei vastausta indikoi taas että portin tila on filtteröity.
Kuvan pakettinumero 16 näyttää miten Buff-maalikone lähettää vastaukseksi SYN/ACK:in, kertoen meille että portti 8080/tcp on auki.

Seuraavaksi pingsweeppausta. Juoksutetaan komento ``$ sudo nmap -sn 10.10.10.198 -v``. Tämä komento ei skannaa portteja mutta etsii hostin. Kutsutaan myös nimellä pingscan.
Lyhyt analysointi : Ping-pyyntö maalikoneelle, ping-vastaus takaisin. ICMP-protokollaa käytetään.

Sitten käytetään No ping - valintaa. eli nmap parametria ``-Pn``. Skippaa hostin löytämisen kokonaan. Wiresharkissa ei näy yhtäkään pingipyyntöä/vastausta.
