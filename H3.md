# Harjoitus 3 | Aktiivinen tiedustelu/Active recon

#### z) Lue artikkelit ja katso videot, tee kustakin muistiinpanot (muutama ranskalainen viiva per artikkeli/video).

[Surveying Essential Tools for Active Reconnaissance](https://learning.oreilly.com/videos/the-art-of/9780135767849/9780135767849-SPTT_04_01)

* On olemassa passiivista ja aktiivista tiedustelua. Passiivisessa tiedustelussa ei lähetetä mitään paketteja suoraan kohdeympäristöön.
* Aktiivisessa tiedustelussa, kuten maalikoneen porttienskannauksessa voi jäädä jälkiä lokiin.
* Nmapista on moneksi, porttiskannaus on vain yksi ominaisuus.
* Verkkohaavoittuvuusskannerit(nmap, OpenVAS) & Webbihaavoittuvuusskannerit(Nikto, Burp Suite,SQLMap)


[Nmap yleiskatsaus ja Case](https://nmap.org/book/nmap-overview-and-demos.html)

* Nmapin yleiskatsausta ja fiktiivinen case.
* Haavoittuvuusarviointi alkaa määrittelemällä mitä IP-osoitealueita maalikohde käyttää, mitkä hostit ovat ylhäällä, mitä palveluita nämä hostit tarjoavat, yleinen verkkotopologia ja mitä palomuuri/filtteröintipolitiikkoja on päällä. 
* Enumeroi jokaisen IP-osoitteen kohteen verkkolohkossa (``-sL``) ja suorittaa käänteisen DNS-lookupin. Viekas tapa, sillä tämä ei hälytä vielä mitään kelloja todennäköisesti.
* Saa selville karkeasti kuinka monta konetta on käytössä ja suuntaa mihin niitä käytetään.
* Seuraavaksi voidaan edetä enemmän tunkeutuvaan skannaukseen mihin kuuluu mm. OS- ja palveluidenversio detektiota.

[Nmap manuaali](https://nmap.org/book/man.html)

* Nmap manuaali
* Pitkä. Todella pitkä.
* Tiivistelmä miten nmappia ajetaan. ``nmap [ <Scan Type> ...] [ <Options> ] { <target specification> }``

[Nmap porttiskannauksen perusteet](https://nmap.org/book/man-port-scanning-basics.html)

* Nmap jakaa portit kuuteen tilaan
* Open = Applikaatio hyväksyy TCP/UDP tai SCTP - yhteyksiä.
* Closed = Suljettu, hyväksyy paketteja mutta ei applikaatioita kuuntelemassa porttia.
* Filtered = Nmap ei osaa sanoa onko portti auki vai kiinni koska pakettifiltteröinti estää sen luotaimia saavuttamasta porttia. Yleensä tarkoittaa että palomuuri filtteröi. Ei anna informaatioita skannaajalle.
* Unfiltered = Portti on saatavilla mutta Nmap ei pysty määrittämään onko se kiinni vai auki. SYN tai FIN skannaus saattaa paljastaa enemmän ( Onko portti auki vai kiinni.)
* Open|filtered = Tähän tilaan päädytään kun Nmap ei kykene määrittelemään onko portti auki vai filtteröity. Tapahtuu kun aukinainen portti ei vastaa.
* Closed|filtered = Nmap ei kykene määrittelemään onko portti kiinni vai filtteröity.
* Tietoturvan perusteet kurssin käyneet yksilöt ovat todennäköisesti tutustuneet näihin tiloihin. Meillä oli ainakin tentissä kysymys juurikin näistä.

[Nmap porttiskannaustekniikoita](https://nmap.org/book/man-port-scanning-techniques.html)

* Lista parametreistä mitä nmap hyväksyy ja mitä ne tekevät
* ``-sS`` parametri tarkoittaa TCP SYN-skannausta, suosituin metodi. Nopea ja melko huomaamaton sillä se ei vie TCP-yhteyksiä loppuun saakka. Antaa luotettavaa dataa portin tilasta.
* ``-sT`` parametri on TCP-yhteysskannaus. Hyvä vaihtoehto kun SYN-skannausta ei voi suorittaa. Tätä yhteyttä käyttää mm. peer2peer-clientit ja webbiselaimet.
* ``-sU`` parametri on UDP-skannausta. Hitaampaa ja "vaikeampaa" kuin TCP-skannaus. Hyvät hyökkääjät eivät koskaan jätä välistä protokollia missä voi piillä haavoittuvuuksia. Versiodetektiota ``-sV``-parametrillä voidaan käyttää avustajana UDP-skannauksessa jotta saadaan selville portit jotka hyväksyvät liikenettä.
* Voit yhdistellä TCP-skannausmetodeita UDP:n kanssa.

#### a) Miten nmap toimii?

Viritetään wireshark kuuntelemaan VPN-liitäntää eli tun0 (HackTheBox-VPN). Juoksutetaan komento ``sudo nmap -sT 10.10.10.198 -v`` (Kohde IP-osoite on Buff-maalikoneen IP.)
* Nmap epäilee että host on alhaalla. TCP-yhteysskannaus suoritettu.
* Wireshark-pakettikaappaus : 
* EDIT: nmap sekoili omiaan, yhteysskannaus suoritettu uudestaan ja dataa liikkuu.. Alempi kuva ja epäonnistunut yhteysskannaus tapahtui varmaankin juuri silloin kun maalikonetta resetoitiin tai muuta vastaavaa hauskaa.
```
14 63.215684154   10.10.15.9 → 10.10.10.198 TCP 60 45624 → 80 [SYN] Seq=0 Win=64240 Len=0 MSS=1460 SACK_PERM=1 TSval=2859221879 TSecr=0 WS=128
 ```
Analysointia : Oma_IP -> MAALIKONE_IP. TCP:tä käyttäen porttiin 80. Kyseessä SYN-paketti mitä käytetään TCP-handshake istunnon setuppaamiseen. Seuraavat kohdat ovat paketin valinnaisia TCP-parametrejä.
``SACK_PERM=1`` tarkoittaa että noodi ``OMA_IP`` osaa hyödyntää SACK-mekanismia (Selective Acknowledgment). Auttaa pakettien häviämisen korjaamisessa. Pähkinänkuoressa : Vastaanottava kone lähettää takaisin SACK-paketteja lähettäjälle että data on saapunut ja lähettäjä voi lähettää uudelleen puuttuvat datasegmentit.
Tsval/TSecr on TCP-aikaleima. ``WS=128`` tarkoittaa sitä että se käyttää Window Scalingia.

Seuraava kohta. "Stealthscanning". ``$ sudo nmap -sS -v 10.10.10.198``. Tämä skannausmetodi ei vie TCP-yhteyksiä loppuun. Saatiin huomattavasti enemmän dataa wiresharkkiin. Pelkkä oletusporttien skannaus tuotti 2027 -paketin liikenteen.

![wshark](https://github.com/mikorpi/Pentest-2020-Autumn/blob/main/images/wireshark_ss.png)

Analysointia : Ensinmäiseksi lähtee ICMP-pingipyyntö. Sitten alkaa TCP-yhteyden muodostaminen, mutta ei kokonaan. Lähettäjältä SYN-paketti kohteelle ja sitten odotellaan vastausta. Jos vastaus SYN/ACK, se indikoi että porttia kuuntelee jokin applikaatio(tila=open). RST eli reset indikoi ei-kuuntelevaa porttia. Ei vastausta indikoi taas että portin tila on filtteröity.
Kuvan pakettinumero 16 näyttää miten Buff-maalikone lähettää vastaukseksi SYN/ACK:in, kertoen meille että portti 8080/tcp on auki.

Seuraavaksi pingsweeppausta. Juoksutetaan komento ``$ sudo nmap -sn 10.10.10.198 -v``. Tämä komento ei skannaa portteja mutta etsii hostin. Kutsutaan myös nimellä pingscan.
Lyhyt analysointi : Ping-pyyntö maalikoneelle, ping-vastaus takaisin. ICMP-protokollaa käytetään.

Sitten käytetään No ping - valintaa. eli nmap parametria ``-Pn``. Skippaa hostin löytämisen kokonaan. Wiresharkissa ei näy yhtäkään pingipyyntöä/vastausta kuten odotettu. Nmap lähettää 2010 pakettia, skannaa  top1000 porttia. Suorittaa SYN-stealthscannin, ylempänä tässä dokumentoinnissa jo mainittuna.

Nmap:in versioenumerointi eli versioskannaus tapahtuu parametrillä ``-sV``. Käytin sitä ainoana parametrinä nmap skannauksessa joten nmap suorittaa 1000portin skannauksen ja kertoo open-tilassa olevat portit ja niiden palvelut, palveluiden versiot. Nmap löysi 8080/tcp portin missä Apache 2.4.43 pyörimässä Win64-koneessa. Myös OpenSSL versio ja PHP versio printtaantuu ulos.
Wireshark analyysiä : Samaa kuin yläpuolella olevassa wireshark-kuvassa. 

#### b) Nmap toimintoja
* -p1-100 ja --top-ports 5. Nämä yhdistettynä eli ``$ sudo nmap -p1-100 --top-ports 5 10.10.10.198 -v``-komento näyttää top5 portit porttietäisyydellä 1-100 sekä niiden tilan ja palvelun mikä siellä on.

![nampb](https://github.com/mikorpi/Pentest-2020-Autumn/blob/main/images/nmap_top5.png)

Ip-osoitteiden valinnassa eli asetetaan tietty alue/etäisyys mitä skannataan. Skannasin HTB-verkon xx.xx.xx.100-200 hostit skipaten host-discoveryn ja porttiskannauksen.

![hostisup](https://github.com/mikorpi/Pentest-2020-Autumn/blob/main/images/ip_osoitteidenvalinta.png)

Yhdistelin hieman seuraavien kohtien parametrejä. ``$ sudo nmap -sC -sV -A -oA h3-b-kohta 10.10.10.198 -v``-komentoa käyttäen. Tämä komento skannaa top 1000 portit TCP-SYN-skannauksella, oletus NSE-kripteillä, versioita enumeroiden,OS-havaitseminen päällä, printaten h3-b-kohta nimisen tiedoston kaikissa formaateissa ( .gnmap, .nmap ja .xml). -v eli verbose antaa inffoa skannauksesta samalla kun se juoksee ja lisää muutenkin verbosea. Vähän hölmösti laitoin -A:n mukaan sillä se suorittaa OS-detektiota,  versiodetektiota,scriptskannausta ja suorittaa tracerouten.(koko lavuaari).

![longcommandnmap](https://github.com/mikorpi/Pentest-2020-Autumn/blob/main/images/pitk%C3%A4komento_nmap.png)

Tämän koneen korkanneena voin todeta että tämä todellakin arvuuttelee käyttöjärjestelmää sillä se ei löytänyt yhtä open-tilassa ja yhtä closed-tilassa olevaa porttia top1000 joukosta. 999 porttia on filtteröity kuten kuvassa näkyy ja yksi open.



Voit myös juoksuttaa nmap-skannauksesi ``--packet-trace``-parametrilla. Nmap printtaa yhteenvedon jokaisesta paketista mitä se lähettää ja vastaanottaa. Tämä on lähinnä hyödyllistä vain debuggaamisessa ja nmap:in käyttäytymisen ymmärtämisessä.

![pt](https://github.com/mikorpi/Pentest-2020-Autumn/blob/main/images/pt_nmap.png)

Sudolla vai ilman?  Vastaus on helppo, sudo aina. Ilman sudoa ei ainakaan oma nmap osaa mitään.

Nopeuskilpailu : Versioenumerointi (-sV) vs OS-detektio,versiodetektio,skriptiskannaus ja traceroute (-A).
* Versioenumerointi : 2013 pakettia lähetetty, koko : 88.548KB -- Vastaanotettu 12, koko : 512B. Ajallinen kesto : 33.74s.
* -A : 2099 Pakettia lähetetty, koko : 96.040KB -- Vastaanotettu 44, koko : 3.868KB. Ajallinen kesto : 50.37s.


#### c) Nmapping SimpleHTTPServer

Nmap on tunnetusti aika kovaääninen skanneri(ainakin oletusarvoilla). Loin pythonilla SimpleHTTPServer:in ja runnasin nmap-komennon siihen. Eli ``python -m SimpleHTTPServer`` webserver pystyyn, kuuntelee defaulttina porttia 8000. Nmapilla ``sudo nmap -sV oma_ip -p 8000``. Python http-palvelin paljastaa nmap-scriptin ``nmaplowercheck1606...``

![nsescript](https://github.com/mikorpi/Pentest-2020-Autumn/blob/main/images/simpleservernmap.png)

#### d) UDP-skannausta
* Yleisimpiä ovat DHCP(67/78portit), SNMP(161,162portit), DNS(53portti) ja Xbox Live palvelu(88portti). UDP-skannausta saa aikaiseksi ``-sU``-argumentilla.
* UDP-skannaus on hankalaa koska UDP-prosessi ei vastaa vastaanotettuihin UDP-viesteihin itse. Pelkkä UDP-skanneri on mahdoton rakentaa ilman muiden protokollien mekanismien apua. UDP tarjoaa minimaalista funktionalisuutta mitä tarvitaan IP:n datagrammin kuljetuspalveluun.
* --reason lippu näyttää syyn miksi portti on tietyssä tilassa, mielestäni -vv (verbosityn lisääminen) käyttö ajaa saman asian.


#### e) Avaa yhteys HTB verkkoon ja osoita että yhteys toimii.

* Ladataan .ovpn paketti HTB:sivuilta
* sudotaan .ovpn paketti, joka muodostaa VPN-yhteyden.
* pingataan vaikka Buff-maalikonetta : ``$ ping 10.10.10.198`` (huom tärkeää. testaa ping ennen VPN-yhteyttä, ja sitten yhteyden kanssa.)
* ipcalc-komennolla voidaan selvittää onko verkko private. (on se)
* Yhteys toimii hyvin.

#### f) Tiedustele HTB-verkko.

Aloitin aktiivisen tiedustelun ping sweeppaamalla koko verkon. Kertoi että 256:sta ip osoitteesta 24:llä on host pystyssä. ``sudo nmap -sn 10.10.10.0/24``
* Violetilla värillä olevat kentät ovat ICMP-protokollaa, vihreällä TCP-protokolla ja harmaalla 443/tcp eli TCP-protokolla joka menee TLS-yhteyteen. Mustalla on paketit missä on vikoja(errors). Punaisella tulee paketit joissa tapahtuu TCP-RESET.
* TCP-RESET eli RST tapahtuu kun odottamaton TCP paketti saapuu hostille. Yleisin syy on että paketti on SYN-paketti joka yrittää saada yhteyden kasaan porttiin missä ei ole prosessia/applikaatiota kuuntelemassa.
* ICMP-protokollan paketit ovat lähinnä pingin lähetystä ja vastausta, muutama aikaleimapyyntökin löytyi.
* TCP-protokollan paketit menevät portteihin 80/http & 443/https, oma kone lähettää ACK-viestejä 80/http:hen ja SYN-viestejä 443/https:ään.
* Error-paketit ovat tyypin 3 ICMP-protokollan "Destination unreachable" - viestejä. Viestittää että kohde on alhaalla.

Vedin hieman kevyemmän skaalan aktiivisen tiedustelun seuraavaksi. Asetin nmapin skannaamaan alueella ``10.10.10.100-200`` versioita enumeroiden, default NSE-skripteillä top1000 porttia. Vain 7 hostia oli ylhäällä tällä alueella. Palveluita löytyi mm:
* 21/tcp/ftp
* 22/tcp/ssh
* 80/tcp/http
* 143/tcp/imap
* 873/tcp/rsync
* 3128/tcp/http-proxy

Wireshark:in sieppaus muuttui protokollien lisääntyessä. Tuli SMTP:tä eli Simple Mail Transfer Protocol:in viestejä ja IMAP:pia eli Internet Message Access - protokollan paketteja. Infoihin tuli PSH-viestejä IMAP:in ansiosta. PSH eli PUSH on tavallaan muistutusta vastaanottajalle että lähettää saadun datan ohjelmalle joka sitä käsittelee.

SSHv2-protokollaa käyttävät paketit käyttivät Diffie-Hellman-avaintenvaihtoprotokollaa. FTP-protokollan viestit plaintekstinä koska FTP. HTTP-protokollan paketteja tutkiessa selvisi myös lähettämäni NSE-skriptit.
![dd](https://github.com/mikorpi/Pentest-2020-Autumn/blob/main/images/nse.png)

Bonus :
* ftp ja SSH käyttäjiä pystyy hydra:lla bruteforceamaan.
* Mm. Dirbusterin käyttöä http-sivustolle, bruteforcee hakemistoja ja tiedostojen nimiä webbiapplikaatiossa.
* Google on myös hyvä työkalu esimerkiksi Apachen version, tai minkä tahansa version tsekkaamiseen että onko se kuinka vanha.

## Lähteet:
* [Surveying Essential Tools for Active Reconnaissance](https://learning.oreilly.com/videos/the-art-of/9780135767849/9780135767849-SPTT_04_01)
* [Nmap yleiskatsaus ja Case](https://nmap.org/book/nmap-overview-and-demos.html)
* [Penetration Testing Course 2020 Autumn - Tunkeutumistestaus ict4tn027-3006 by Tero Karvinen](http://terokarvinen.com/2020/tunkeutumistestaus-kurssi-pentest-course-ict4tn027-3006-autumn-2020/#h4-walktrough)
* [Nmap manuaali](https://nmap.org/book/man.html)
* [Nmap porttiskannauksen perusteet](https://nmap.org/book/man-port-scanning-basics.html)
* [Nmap porttiskannaustekniikoita](https://nmap.org/book/man-port-scanning-techniques.html)
* [Wireshark.org](https://www.wireshark.org/docs/wsug_html_chunked/ChapterWork.html)
* [Wireshark.docs](https://www.wireshark.org/docs/)
* [HackTheBox](https://www.hackthebox.eu/)
* [UDP for Redteams](https://securitytrails.com/blog/top-scanned-ports)
