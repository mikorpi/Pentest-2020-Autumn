# H4 | Walkthrough-videot & aktiivista tiedustelua (HTB)

### z) [Kaksi artikkelia läpikävelyistä](https://0xdf.gitlab.io/)

* HTB:Fuse. Valitsin tämän artikkelin sillä siinä hyökätään Windows-maalikoneeseen eikä se ole perinteinen webpalvelin-maalikone.
  * Abusetaan printterin admin-sivua
  * Kerätään käyttäjätietoja spiderilla webbisivulta/linkeistä (CeWL.ruby)
  * Bruteforcetaan tie sisään.
  * Käytetään WinRM:ää kredentiaaleilla ja ladataan hyötykuorma ajurin avulla jotta saadaan root-shell.
  
* HTB:Buff (pwnattu).
  * OSCP-tyylinen boksi, webbisivuna fitness-painotteinen sivu
  * Vanhalla softalla tehty sivu jossa vulni(etäkoodin juoksutus/RCE)
  * Windows Defender blokkaa tiettyjä asioita mutta tietyt toimii
  * Puskurin ylivuoto(PoC)-exploitilla Administrator:iksi, työkaluna msfvenom-payload generaattori
  
  ### z) [Läpikäyntivideot IppSec](https://www.youtube.com/channel/UCa6eh7gCkpPo5XXUDfygQQA)
* HTB:Sauna. Hyökätään aktiivihakemistoon. Valitsin tämän sillä en ole koskaan hyökännyt vastaavanlaiseen ympäristöön.
  * SMB:n tökkimistä CrackMapExec:illä ja SMBMapilla
  * Identifioidaan validit käyttäjät KerBrute:lla
  * Impacket skripteillä AS-REP roastausta > Hyökätään Kerberos:iin > Kräkätään aktiivihakemistoa (AD)
  * Hashcatilla kräkätään saatu hash
  * [Bloodhound:illa](https://github.com/BloodHoundAD/BloodHound) nähdään piilotetut relaatiot AD-ympäristössä
  * Impacket-skriptillä salasanatiivisteiden dumppaus Domain Controllerista. (DSYNC)
  * psexec.py > hashin avulla Adminiksi.
  
* HTB:Remote. Windows-maalikone
  * enumeroidaan ftp:tä ja smb:tä
  * Huom! Windowspalvelimet eivät ole "case-sensitive" eli voit runnata sanalistat pienillä kirjaimilla.
  * NFS:än tökkimistä, löydetään umbraco.sdf joka on tietokanta
  * Adminin salasana löytyy > kirjaudutaan sisään
  * Umbracossa vulni & julkinen exploitti (remote code execution) > reverseshell
  * Löydetään UsoSvc-palvelu > editoidaan sitä suorittamaan reverse shell > saadaan root shell.

  
### a) Uudet työkalut

#### #1 [Nikto - webserver-skanneri](https://github.com/sullo/nikto)

* Nikto skannaa webbipalvelimen etsien haavoittuvuuksia kuten vanhoja versioita & konfigurointiasetuksia.
* Nikto printtaa jotkut haavoittuvuudet "Open Source Vulnerability Database" (OSVDB)-sarjanumeroin, joten niiden tarkempi tutkailu helpottuu.
* Tehokas mutta agressiivinen

![nikto](https://github.com/mikorpi/Pentest-2020-Autumn/blob/main/images/nikto_scan.png)

#### #2 [CeWL - Custom Word List generator](https://github.com/digininja/CeWL/)

* CeWL on rubylla kirjoitettu applikaatio joka crawlaa(spideroi) kohdewebbisivun määriteltyyn syvyyteen asti keräten uniikkeja sanoja, luoden sanalistan.
* Sanalistaa voidaan hyödyntää salasanojen murtamistyökaluilla kuten JohntheRipper:illä (bruteforce)
* HUOM. Tämän kanssa pitää olla tarkkana sillä se saattaa crawlata tiensä sivulta pois jos annat sille tarpeeksi syvyyttä.
* Uniikkeja sanoja sivulta? Eikö tavalliset sanalistat kelpaa? Webbisivu saattaa sisältää esimerkiksi työntekijöiden ym. nimiä jotka voivat olla potentiaalisia käyttäjätunnuksiakin.

![cewl](https://github.com/mikorpi/Pentest-2020-Autumn/blob/main/images/cewl_doc.png)

#### #3 [FFUF - WEBFUZZER](https://github.com/ffuf/ffuf)

* Nopea webfuzzaaja kirjoitettu Go:lla
* Fuzzauksen idea on automatisoida satunnainen syöttö applikaatioon/webpalvelimeen etsien implementaatiomokia
* Korvike pythonilla(3) kirjoitetulle [wfuzz:ille](https://github.com/xmendez/wfuzz)

![ffuf](https://github.com/mikorpi/Pentest-2020-Autumn/blob/main/images/ffuf.png)

#### #4 SQLMAP



### b) HTB-koneiden tiedustelu

#### #1 HackTheBox - Doctor

Runnasin nmapin komennolla `$sudo nmap -sC -sV -oA recon -p- -T4 -v 10.10.10.209` , eli versioida enumeroiden, perus NSE-skriptejä käyttäen, tulostaen kaikki output-muodot, kaikki portit skannattuna, tasolla 4 eli kohtuu agressiivisesti.

![docnmap](https://github.com/mikorpi/Pentest-2020-Autumn/blob/main/images/htb_doctor_nmap.png)

Tuloksista huomaa että:
* Palvelimen OS on Linux, distrona Ubuntu
* Porttia 22/tcp kuuntelee ssh-palvelu (OpenSSH 8.2p1, v2/protocol 2.0)
* Porttia 80/tcp kuuntelee http, tarkemmin ottaen Apachen webbipalvelin versioiltaan 2.4.41
* Portissa 8089/tcp pyörii Splunkd SSL-palvelu. Nmap kertoo myös sertin tietoja laajalti :
  * Kohde
  * issuer (antaja? lähettäjä?)
  * Julkisen avaimen tyypin ja bitit (rsa-2048)
  * Allekirjoitusalgoritmi (SHA256-RSA2048)
  * Aikaväli milloin avain on validi
  * MD5-tiiviste
  * SHA-1-tiiviste
 
 Aika tyypillisiä palveluita oletusporteissa jos Splunkd:ta ei ota huomioon. Splunkd on uusi tuttavuus itselleni. Lähtisin tästä jatkamaan tiedustelua menemällä katsomaan webbisivun mitä webbipalvelin pyörittää. Laitan Nikton skannaamaan sen ennen manuaalista tökkimistä. Nikto on webbihaavoittuvuusskanneri joka on todella äänekäs. Se ei edes yritä peitellä tekojaan.
 
![niktodoctor](https://github.com/mikorpi/Pentest-2020-Autumn/blob/main/images/nikto_scan.png)

Nikto vielä varmistaa että Apachen versio on 2.4.41 ja distribuutiona toimii Ubuntu.
* Clickjackkaus voisi toimia sivulla, mutta aktiivisia käyttäjiähän siellä ei ole sillä tämä ei ole "oikea" palvelu.
* Clickjackkauksella/UI redress - hyökkäyksellä on monta nimeä mutta käytänössä se tarkoittaa käyttäjän sumutusta, klikkaamalla tiettyä elementtiä ei tapahdukkaan toivottua/oletettua asiaa vaan se mitä olet itse "craftannut" sen tilalle. Esimerkkinä vaikka uudelleenohjaus itsetekemälle huijaussivulle.
* Myös XSS-hyökkäys voisi toimia sivulla, Nikto ei löytänyt suojausotsikkoa.
* X-Content-Type-Options-otsikkokaan ei ole päällä, tämä antaa mahdollisuuden suorittaa "drive-by lataushyökkäyksiä".
* Drive-by lataushyökkäys tarkoittaa että webbisivu voi pakottaa(yrittää) käyttäjää lataamaan tiedoston/(haitta)ohjelman suoraan ilman lupaasi.
* Myöskään CGI-hakemistoja Nikto ei havaitse. CGI-hakemistoissa on palvelimen kootut skriptit. Mitä tahansa laitat CGI-hakemistoon, sitä tullaan käsittelemään ohjelmana.
* "Palvelin voi vuotaa inodeja ETagin kautta..." on aika falsepositive-tyyppinen juttu. Inode on datarakenne mitä Linuxin tiedostojärjestelmä käyttää, näiden paljastuminen ei anna mitään exploit-arvoa hyökkääjälle.
* Nikto paljastaa hyväksytyt HTTP-metodit (GET/POST/OPTIONS/HEAD)
* Nikto löytää `css/` ja `images/`-hakemistot ja printtaa pari eri OSVDB-tunnusta mitä voi tutkailla jos jotain exploittaamisentapaistakaan löytyisi. (OSVDB:n tiedot olivat hyödyttömiä.)

Tästä viisaampana voikin suunnata katsomaan hakemistot, löytyykö sieltä mitään mielenkiintoista. Nmap+Nikto on hyvä kombinaatio päästä alkuun. Kaikkien palveluiden,käyttöjärjestelmien yms. versionumerot on hyvä tarkistaa internetistä ja searchsploit:ista haavoittuvuuksien toivossa. Myös exiftool:in käyttö kuvia vastaan paljastaen niiden metatiedon on hyvä suunnanantaja, onko palvelin kuinka vanha. Esimerkkinä: Exiftool kertoo milloin kyseistä kuvaa on muokattu.


#### #2 HackTheBox - Worker

Runnasin nmapin komennolla `$sudo nmap -sC -sV -oA recon -p- -T4 -v 10.10.10.203` , eli versioida enumeroiden, perus NSE-skriptejä käyttäen, tulostaen kaikki output-muodot, kaikki portit skannattuna, tasolla 4 eli kohtuu agressiivisesti.

![nmapworker](https://github.com/mikorpi/Pentest-2020-Autumn/blob/main/images/htb_worker_nmap.png)

Selviääkin heti että kyseessä on Windows-maalikone.
* Portissa 80/tcp on Microsoftin Internet Information Services -applikaatio webbipalvelimella. Versionumerona 10, eli aika vanha.
* Pienellä arvuuttelulla voisin lotota että palvelin on Windows Server 2012, sillä IIS 10 on vanha ja haavoittuvainen.
* Portissa 3690/tcp toimii Subversion svnserve-palvelulla. Tätä yleensä käytetään jos halutaan pieni asennus tai missä täyttä Apache-webbipalvelinta ei voida käyttää syystä tai toisesta.
* Portissa 5985/tcp toimii Microsoftin HTTPAPI 2.0 (SSDP/UPnP). Toinen potentiaalinen lottovoitto löydetty.

IIS 10.0 löytyi joitakin haavoittuvuuksia, puskurin ylivuotoa. Svnserve-palvelukin vaikutti heppoiselta.
HTTPAPI:a ei kannata exposaa ulkopuolelle mutta hyökkääjälle se on hyvä juttu. Nopealla curl-error-testillä selvisi että HTTP.sys vastaa IIS:än sijaan pyyntöihin. Huomaa että `Server:` ei ole IIS 10.0 vaan HTTPAPI2.0.
`$ curl -v http://10.10.10.203/ -H "Range: bytes=00-18446744073709551615"`

```html
> GET / HTTP/1.1
> Host: 10.10.10.203
> User-Agent: curl/7.72.0
> Accept: */*
> Range: bytes=00-18446744073709551615
> 
* Mark bundle as not supporting multiuse
< HTTP/1.1 400 Bad Request
< Content-Type: text/html; charset=us-ascii
< Server: Microsoft-HTTPAPI/2.0
< Date: Sat, 28 Nov 2020 17:40:34 GMT
< Connection: close
< Content-Length: 339

```
HTTP.sys:iä lähtisin tutkailemaan lisää ensinmäiseksi, sitten noita muita. Nmap ei suostunut selvittämään palvelimen käyttöjärjestelmää vaikka kuinka kauniisti pyysi. Myöskin tiedustelun automatisointi esimerkiksi Nikto:lla tai gobuster:illa on hyvin suositeltavaa!


#### #3 HackTheBox - Buff (pwned(retired))

Skannasin koneen versioita enumeroiden, perus NSE-skripteillä, yleisimmät 1000porttia skannattuna. `$ sudo nmap -sC -sV -oA recon 10.10.10.198 -v`

![nmapbuff](https://github.com/mikorpi/Pentest-2020-Autumn/blob/main/images/julkinenbuff.png)

Tulokset : 
* 8080/tcp:ssä Apachen webbipalvelin versioltaan 2.4.43. Nmap myös kertoo että kyseessä on 64-bittinen Windows. Eli windows-maalikone kyseessä. Myös OpenSSL- ja PHP-versiot printtaantuvat ulos.
* Apachen webbipalvelin pyörittää mrb3n's brohut-nimistä sivua. Webbisivut ovat aina tsekkaamisen arvoinen kohde.
* Muut portit ovat kiinni.

Tämä nmap tulos kertoi hyökkääjälle:
* Webbisivu on avoinna portissa 8080
* Kohdekone on Windows(64-bittinen)

Tästä on hyvä jatkaa sivun manuaalisella tökkimisellä, muistakaa automatisoida osa tiedusteluanne. Nikto-haavoittuvuusskannaus ja gobuster-hakemistobruteeminen ovat hyviä työkaluja tähän. Ne raksuttavat kiltisti taustalla ja voit keskittyä manuaaliseen webbisivun tökkimiseen.

#### #4 HackTheBox - Time (pwned)

Tiedustelu lähti käyntiin nmapilla skannaamalla kaikki portit agressiivisesti(T4), perus NSE-skripteillä ja versioita enumeroiden. `$ sudo nmap -sC -sV -oA nmap/recon -p- -T4 -v 10.10.10.214`

![ddd](https://github.com/mikorpi/Pentest-2020-Autumn/blob/main/images/recon_nmap.png)

Nmap-skannuksesta selviää:
* Käyttöjärjestelmä on Linux, distrona Ubuntu.
* 22/tcp portissa on ssh-palvelu. Tarkemmin ottaen OpenSSHv2 versio 8.2
* 80/tcp portissa Apachen webbipalvelin versioltaan 2.4.41 tarjoilemassa webbisivua otsikolla "Online JSON parser"

Mitään erikoisia haavoittuvuuksia ei näistä versioista löytynyt. Webbisivun manuaalisella ja automatisoidulla tökkimisellä on hyvä jatkaa tästä. Työkaluksi Gobuster-hakemistonmurtaja ja/tai Nikto-webhaavoittuvuusskanneri hoitamaan automaatio-osuus.

#### #5 HackTheBox - Academy

Tiedustelu alkoi nmap-skannauksella, versioita enumeroiden, perus NSE-skripteillä, agressiivisesti kaikki portit skannaten.
`$ sudo nmap -sC -sV -oA nmap/recon -T4 -v 10.10.10.215`

![nmap_academy](https://github.com/mikorpi/Pentest-2020-Autumn/blob/main/images/academynmap.png)

Tulokset:
* Distribuutiona Ubuntu & OS on Linux.
* Portissa 22/tcp toimii ssh-palvelu | OpenSSHv2 versioltaan 8.2
* Portissa 80/tcp on Apachen webbipalvelin versioltaan 2.4.41
* Portissa 33060/tcp mysqlx? Nmap ei ole aivan varma mikä palvelu siellä pyörii.
* Nmapin NSE-skripti `fingerprint-strings` suorittaa palveluihin kohdistuvan tutkailun. Nämä merkkijonot **voivat antaa osviittaa** mikä palvelu portissa on.

  * LDAPSearchReq >> LDAP on hakemistopalvelujen käyttöön tarkoitettu verkkoprotokolla.
  * DNSStatusRequestTCP >> DNS käyttää TCP:tä zone transferiin
  * NotesRPC >> RPC (Remote Procedure Call) on etänä suoritettu menettelykutsu. Eli siis protokolla. Tämän protokollan tarkoitus on pyytää palvelua ohjelmalta joka sijaitsee verkossa mistä se ei itse ole perillä.
  * SSLSessionReq  & TLSSessionReq >> Nämä indikoivat istuntopyyntöjen olemassaolosta salatussa yhteydessä. (https)
  * X11Probe >> X11-tiedustelu. X11 pähkinänkuoressa : Terminaalisi on palvelin. Applikaatiot jotka ovat yhteydessä X11:seen voivat tunnistaa mm. näppäimenpainalluksia, dumpata näytön sisällön ja tehdä muuta hauskaa. Käytännössä viet maalikohteen näppäimistön, näytön ja hiiren.
  * afp: Invalid message HY000 >> afp liittyy jotenkin fontteihin.

Sitten printtaantuu vaikealukuista tavaraa. Jos on tarkka, huomaat että sieltäkin voi saada tiedonmurusia. Kolmanneksi alimmalla rivillä (SF:tagit) löytyy stringi `ms-sql-s` mikä indikoi Microsoftin SQL Server:iä.
Lopputuloksena tahtoisin uskoa että kyseessä on kuin onkin MySQL-tietokantapalvelu.

Elikkä palvelut olivat SSH,HTTP ja MySQL(?). HTTP-sivun nimi `"Did not follow redirect to http://academy.htb/"` indikoi että siellä on uudelleenohjausongelma. No route to host (Host unreachable) - ilmoitus tulee kun koitat mennä manuaalisesti webbisivulle. Selvisikin että ongelma löytyi minun päästä, ja sivu aukeaakin normaalisti.

Sivulla löytyy Login ja register - valikot. Ne vievät käyttäjän php-sivulle. Ennen manuaalista tökkimistä olisi suositeltavaa automatisoida osa tiedustelua, joten gobuster-hakemistobruteforce .php-päätteillä olisi järkevä ratkaisu.

Pistetään Gobuster murtamaan hakemistoja pienellä sanalistalla & php-päätteillä.
`$ sudo gobuster dir -u http://academy.htb/ -w /usr/share/dirbuster/wordlists/directory-list-2.3-small.txt -o gobu.out -x .php`

![gobust](https://github.com/mikorpi/Pentest-2020-Autumn/blob/main/images/gobust_Academy_better.png)

Gobuster on vasta raksuttanut puoleen väliin (55.41%) ja on löytänyt jo `/admin.php`-sivun ja `/config.php`-sivun. Mielenkiintoisia kohteita hyökkääjän kannalta, näistä on hyvä jatkaa. Myös proxyn käyttö on hyvä tapa selvittää asioita. Esimerkiksi Burp Suiten proxylla siepattu ohjaus näyttää että Username-kenttä on `uid` ja Password-kenttä on `password`. Kombinaationa nämä ovat siis `uid=käyttäjä&password=salasana`. Myös maalikoneiden webbisivujen lähdekoodin vilkaisu voi olla hyödyllistä.
